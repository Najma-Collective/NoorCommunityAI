<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nour - AI Tutor</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Questrial&family=Marcellus&display=swap" rel="stylesheet">
    
    <!-- Markdown Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* =====================================================================
           DESIGN SYSTEM
           ===================================================================== */
        :root {
            /* Palette - Sage Theme (Default) */
            --primary-color: #5c6b53;
            --secondary-color: #8da386;
            --accent-color: #d4a373;
            --bg-color: #f0f2ef;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.9);
            --text-dark: #2a3328;
            
            /* Text Highlights (The Key) */
            --hl-vocab-bg: #eaddcf;     /* Warm Sand for Vocab */
            --hl-vocab-text: #8f5b34;   
            --hl-grammar-bg: #dee8e6;   /* Cool Mist for Grammar */
            --hl-grammar-text: #4a7c76; 
            --hl-alert-bg: #fce8e8;     /* Soft Rose for Correction */
            --hl-alert-text: #c45a5a;   

            /* Fonts */
            --font-display: "Marcellus", serif; 
            --font-body: "Nunito", sans-serif;
            --font-ui: "Questrial", sans-serif;
        }

        /* Ocean Theme */
        body.theme-ocean { 
            --primary-color: #46696d; --secondary-color: #72a5a5; 
            --hl-vocab-text: #d67a5b; --hl-grammar-text: #2c5559;
            --bg-color: #ebf2f2;
        }
        
        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0; height: 100dvh; font-family: var(--font-body);
            color: var(--text-dark); font-size: 16px;
            overflow: hidden; background: var(--bg-color); transition: background 0.8s ease;
        }

        /* Animation Canvas */
        #wave-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.5; }

        #app-wrapper {
            position: relative; z-index: 1; display: flex; align-items: center; justify-content: center;
            height: 100%; padding: 2vh;
        }

        #activity-container {
            width: 100%; max-width: 1400px; height: 96vh;
            display: grid; grid-template-columns: 1fr 340px; grid-template-rows: auto 1fr auto;
            background: var(--glass-bg); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 32px; border: 1px solid var(--glass-border);
            box-shadow: 0 30px 90px -20px rgba(42, 51, 40, 0.15); overflow: hidden;
        }

        /* --- HEADER --- */
        .chat-header {
            grid-column: 1 / -1; padding: 1.2rem 2.5rem;
            background: rgba(255,255,255,0.4); border-bottom: 1px solid rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        
        .header-left { display: flex; align-items: center; gap: 1.2rem; }
        .header-info h1 { font-family: var(--font-display); margin: 0; font-size: 1.4rem; color: var(--primary-color); }
        .header-status { font-family: var(--font-ui); font-size: 0.8rem; color: var(--secondary-color); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        .avatar-wrapper {
            position: relative; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
        }
        .avatar-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background: var(--primary-color); color: #fff;
            font-family: var(--font-display); font-size: 1.6rem;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .avatar-aura {
            position: absolute; inset: -4px; border-radius: 50%;
            background: var(--secondary-color); opacity: 0.3; z-index: 1;
            animation: breathe 4s ease-in-out infinite;
        }
        
        /* Avatar Animations */
        .avatar-wrapper.listening .avatar-aura { animation: pulseFast 1s infinite; background: var(--accent-color); opacity: 0.6; }
        .avatar-wrapper.speaking .avatar-circle { animation: speakPulse 0.3s infinite alternate; }

        /* --- CHAT AREA --- */
        #chat-history {
            grid-column: 1 / 2; grid-row: 2 / 3;
            overflow-y: auto; padding: 3rem;
            display: flex; flex-direction: column; gap: 2rem; scroll-behavior: smooth;
        }

        .message {
            max-width: 85%; opacity: 0; 
            animation: floatIn 0.5s forwards; line-height: 1.7;
        }

        .message.ai {
            align-self: flex-start; width: 100%; max-width: 90%;
            font-size: 1.05rem; color: var(--text-dark);
        }
        
        .message.user {
            align-self: flex-end; padding: 1rem 1.5rem;
            color: white; border-radius: 20px 20px 4px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 8px 20px -5px rgba(92, 107, 83, 0.3);
        }

        .message.error {
            align-self: center; background: #ffebee; color: #c62828;
            padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem;
        }

        /* --- AI VISUAL COMPONENTS (CARDS & CAROUSELS) --- */
        
        /* Carousel Container */
        .carousel {
            display: flex; gap: 1.5rem; overflow-x: auto; 
            padding: 1.5rem 0.5rem; margin: 1rem 0;
            scroll-snap-type: x mandatory;
        }
        .carousel::-webkit-scrollbar { height: 6px; }
        .carousel::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

        /* Learning Card */
        .learning-card {
            flex: 0 0 260px; scroll-snap-align: center;
            background: #fff; border-radius: 20px;
            padding: 1.5rem; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.8);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .learning-card:hover { transform: translateY(-5px); }
        .learning-card h3 { 
            font-family: var(--font-display); color: var(--primary-color); 
            margin-top: 0; border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;
        }

        /* Dialogue Box */
        .dialogue-box {
            background: rgba(255,255,255,0.5); border-radius: 16px;
            padding: 2rem; border-left: 4px solid var(--primary-color);
            margin: 2rem 0;
        }
        .d-line { margin-bottom: 1rem; display: flex; gap: 1rem; }
        .d-name { font-weight: 800; min-width: 80px; color: var(--primary-color); font-family: var(--font-display); }

        /* Highlights */
        .hl-vocab { background: var(--hl-vocab-bg); color: var(--hl-vocab-text); padding: 2px 6px; border-radius: 4px; font-weight: 700; border-bottom: 2px solid rgba(0,0,0,0.1); }
        .hl-grammar { background: var(--hl-grammar-bg); color: var(--hl-grammar-text); padding: 2px 6px; border-radius: 4px; font-weight: 700; border: 1px dashed var(--secondary-color); }
        .hl-feedback { background: var(--hl-alert-bg); color: var(--hl-alert-text); padding: 2px 6px; border-radius: 4px; text-decoration: underline wavy; }

        /* --- SIDEBAR (NAVIGATOR) --- */
        #side-panel {
            grid-column: 2 / 3; grid-row: 2 / 4;
            background: rgba(255,255,255,0.5); border-left: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .panel-header {
            padding: 1.5rem; font-family: var(--font-display); font-weight: 700; 
            color: var(--primary-color); background: rgba(255,255,255,0.3);
        }

        #tracker-container {
            flex: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem 1.5rem;
        }
        
        .step-item {
            position: relative; padding: 0 0 1.5rem 1.5rem;
            border-left: 2px solid #e0e0e0;
        }
        .step-item:last-child { border-left: 2px solid transparent; }
        .step-dot {
            position: absolute; left: -7px; top: 0; width: 12px; height: 12px; 
            border-radius: 50%; background: #e0e0e0; border: 2px solid #fff; transition: all 0.3s;
        }
        .step-title { font-size: 0.8rem; color: #999; font-weight: 700; }

        .step-item.active .step-dot { background: var(--accent-color); transform: scale(1.3); }
        .step-item.active .step-title { color: var(--accent-color); }
        .step-item.done .step-dot { background: var(--primary-color); }
        .step-item.done { border-left-color: var(--primary-color); }

        /* --- INPUT --- */
        .input-area {
            grid-column: 1 / 2; grid-row: 3 / 4;
            padding: 2rem 3rem; display: flex; gap: 1rem; align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1; background: #fff; border-radius: 28px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex; align-items: center; padding: 6px 6px 6px 20px;
        }
        
        textarea {
            width: 100%; border: none; background: transparent;
            font-family: var(--font-body); font-size: 1rem; outline: none; resize: none; max-height: 120px;
        }

        button.icon-btn {
            width: 44px; height: 44px; border-radius: 50%; border: none; background: transparent; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
            color: #aaa;
        }
        button.icon-btn:hover { background: #f5f5f5; color: var(--primary-color); }
        
        #mic-btn.listening { background: var(--hl-alert-text); color: white; animation: pulseRed 1.5s infinite; }
        #send-btn { width: 48px; height: 48px; background: var(--primary-color); color: white; border-radius: 20px; opacity: 0.9; }
        #send-btn:hover { opacity: 1; transform: scale(1.05); }

        /* Animations */
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.15; } }
        @keyframes floatIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        @keyframes pulseFast { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.2); opacity: 0.0; } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(196, 90, 90, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(196, 90, 90, 0); } 100% { box-shadow: 0 0 0 0 rgba(196, 90, 90, 0); } }
        @keyframes speakPulse { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* API Modal */
        #api-modal { position: fixed; inset: 0; background: rgba(240, 242, 239, 0.95); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 3rem; border-radius: 32px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.1); }
        .api-input { width: 100%; padding: 14px; margin: 1.5rem 0; border: 2px solid #eee; border-radius: 12px; outline: none; }
        .start-btn { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 99px; font-weight: 700; cursor: pointer; }

    </style>
</head>
<body class="theme-sage">

    <canvas id="wave-canvas"></canvas>

    <div id="app-wrapper">
        <div id="activity-container">
            
            <!-- HEADER -->
            <div class="chat-header">
                <div class="header-left">
                    <div class="avatar-wrapper" id="avatar-wrapper">
                        <div class="avatar-aura"></div>
                        <div class="avatar-circle">N</div>
                    </div>
                    <div class="header-info">
                        <h1>Nour</h1>
                        <div class="header-status" id="header-status">Waiting</div>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="icon-btn" id="sound-btn" title="Toggle Sound">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    </button>
                    <button class="icon-btn" id="theme-btn" title="Switch Theme">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </button>
                </div>
            </div>

            <!-- CHAT -->
            <div id="chat-history"></div>

            <!-- SIDEBAR -->
            <div id="side-panel">
                <div class="panel-header">Session Map</div>
                <div id="tracker-container"></div>
                
                <div style="margin-top:auto; padding:1.5rem; text-align:center;">
                    <button class="start-btn" id="download-btn" style="display:none; font-size:0.9rem; padding:12px;">Download Feedback PDF</button>
                </div>
            </div>

            <!-- INPUT -->
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="user-input" placeholder="Type or tap microphone..." rows="1"></textarea>
                    <button class="icon-btn" id="mic-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                </div>
                <button class="icon-btn" id="send-btn" style="color:white;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="api-modal">
        <div class="modal-box">
            <h1 style="font-family:var(--font-display); color:var(--primary-color);">Welcome Back</h1>
            <p>Please enter your Gemini API Key to begin.</p>
            <input type="password" id="api-key-input" class="api-input" placeholder="Paste API Key here...">
            <button class="start-btn" id="start-session-btn">Start Session</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const MODEL_NAME = 'gemini-2.5-flash';
        let GEMINI_API_KEY = '';
        
        // --- STAGES FOR TRACKER ---
        const STAGES = [
            "Lead-in",
            "Pre task A (Activate)",
            "Pre task B (Model)",
            "Pre task C (Lang Focus)",
            "Pre task D (Pron)",
            "Task Prep",
            "Main Task",
            "Reporting",
            "Feedback"
        ];

        // --- SYSTEM PROMPT (Enforcing Visuals) ---
        const SYSTEM_PROMPT = `
You are Nour, a somatic, aesthetic AI tutor. You are calm, patient, and visual.
Your goal is to guide the student through a TBL lesson using specific visual HTML layouts.

### VISUAL & FORMATTING RULES (STRICT)
1.  **NO MARKDOWN LISTS**: When presenting options, steps, or choices, you MUST use the \`<div class="carousel">\` layout.
2.  **HIGHLIGHTS**: 
    -   Vocabulary: \`<span class="hl-vocab">term</span>\`
    -   Grammar: \`<span class="hl-grammar">structure</span>\`
    -   Correction/Feedback: \`<span class="hl-feedback">correction</span>\`
3.  **DIALOGUES**: Use \`<div class="dialogue-box">\` wrapping \`<div class="d-line"><span class="d-name">Name:</span> text...</div>\`.
4.  **CARDS**: Concepts must be in \`<div class="learning-card"><h3>Title</h3><p>Content</p></div>\`.

### TRACKER CONTROL
At the start of every message, you MUST output a hidden tag indicating the current stage from this list: [${STAGES.join(', ')}].
Format: \`[[STAGE: Pre task A (Activate)]]\`

### LESSON PLAN
1.  **Lead-in**: Ask a somatic grounding question.
2.  **Pre task A**: Ask about a past project (Activate schema).
3.  **Pre task B**: Present a dialogue between Nadia and Omar about 'Dependencies'. Use the DIALOGUE layout.
4.  **Pre task C**: Analyze 'Second Conditional'. Use CARD layout.
5.  **Task Prep**: Assign roles (Monolith vs Microservices).
6.  **Main Task**: Roleplay the debate.
7.  **Feedback**: Provide corrections using highlight spans.

Start the conversation now.
`;

        // --- UI LOGIC ---
        const chatEl = document.getElementById('chat-history');
        const inputEl = document.getElementById('user-input');
        const trackerContainer = document.getElementById('tracker-container');
        let chatHistory = [];
        let isMuted = false;

        // Initialize Tracker
        function initTracker() {
            trackerContainer.innerHTML = '';
            STAGES.forEach((stage, i) => {
                const el = document.createElement('div');
                el.className = `step-item ${i === 0 ? 'active' : ''}`;
                el.id = `stage-${i}`;
                el.innerHTML = `<div class="step-dot"></div><div class="step-title">${stage}</div>`;
                trackerContainer.appendChild(el);
            });
        }

        function updateTracker(stageName) {
            const idx = STAGES.findIndex(s => stageName.toLowerCase().includes(s.toLowerCase().split(' ')[0].toLowerCase()));
            if (idx !== -1) {
                for(let i=0; i<idx; i++) {
                    document.getElementById(`stage-${i}`).classList.remove('active');
                    document.getElementById(`stage-${i}`).classList.add('done');
                }
                const curr = document.getElementById(`stage-${idx}`);
                curr.classList.remove('done');
                curr.classList.add('active');
                curr.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        // --- MARKDOWN & PARSING ---
        // Ensure we handle [object Object] by properly extracting text
        async function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            // Clean tags for display
            let displayHtml = text.replace(/\[\[STAGE:.*?\]\]/g, '');
            
            // Render Markdown/HTML
            try {
                // If marked isn't loaded for some reason, fallback to text
                if (typeof marked !== 'undefined') {
                    div.innerHTML = marked.parse(displayHtml);
                } else {
                    div.innerHTML = displayHtml;
                }
            } catch (e) {
                console.error("Markdown Error", e);
                div.textContent = displayHtml;
            }

            chatEl.appendChild(div);
            // Wait for images/layout before scrolling
            requestAnimationFrame(() => {
                chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' });
            });
        }

        async function processAIResponse(rawText) {
            // Extract Stage
            const stageMatch = rawText.match(/\[\[STAGE:\s*(.*?)\]\]/);
            if (stageMatch) {
                updateTracker(stageMatch[1]);
            }
            return rawText;
        }

        // --- API CALL ---
        async function sendMessage() {
            const text = inputEl.value.trim();
            if (!text) return;
            
            inputEl.value = '';
            appendMessage('user', text);
            document.getElementById('header-status').textContent = "Thinking...";
            document.getElementById('avatar-wrapper').classList.add('listening');

            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        system_instruction: { parts: [{ text: SYSTEM_PROMPT }] }
                    })
                });

                const data = await response.json();
                
                // CRITICAL FIX: Handle potential API errors or malformed data
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("Empty response from AI");
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Process and Display
                const processedText = await processAIResponse(aiText);
                appendMessage('ai', processedText);
                
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                
                // Speak
                if (!isMuted) speak(processedText);

            } catch (error) {
                console.error(error);
                appendMessage('error', `Error: ${error.message}`);
            } finally {
                document.getElementById('header-status').textContent = "Online";
                document.getElementById('avatar-wrapper').classList.remove('listening');
            }
        }

        // --- SPEECH RECOGNITION (FIXED) ---
        let recognition;
        const micBtn = document.getElementById('mic-btn');
        
        // Browser compatibility check
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                micBtn.classList.add('listening');
                inputEl.placeholder = "Listening...";
            };
            
            recognition.onend = () => {
                micBtn.classList.remove('listening');
                inputEl.placeholder = "Type or tap microphone...";
                // Trigger send automatically if desired, or let user click send
            };
            
            recognition.onerror = (event) => {
                console.error("Speech Error:", event.error);
                micBtn.classList.remove('listening');
                alert("Microphone error: " + event.error);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputEl.value = transcript;
            };

            micBtn.addEventListener('click', () => {
                if (micBtn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
        } else {
            micBtn.style.display = 'none'; // Hide if not supported
            console.log("Speech Recognition not supported in this browser.");
        }

        // --- TEXT TO SPEECH (FIXED) ---
        const synth = window.speechSynthesis;
        let voices = [];
        
        // Load voices explicitly
        function loadVoices() {
            voices = synth.getVoices();
        }
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speak(text) {
            if (synth.speaking) synth.cancel();
            
            // Clean HTML tags for speech
            const cleanText = text.replace(/<[^>]*>/g, '').replace(/\[\[.*?\]\]/g, '');
            const utterThis = new SpeechSynthesisUtterance(cleanText);
            
            // Try to find a female voice
            const voice = voices.find(v => v.name.includes('Google UK English Female')) || 
                          voices.find(v => v.name.includes('Female')) || 
                          voices[0];
            
            if (voice) utterThis.voice = voice;
            utterThis.pitch = 1;
            utterThis.rate = 1.1;
            
            utterThis.onstart = () => document.getElementById('avatar-wrapper').classList.add('speaking');
            utterThis.onend = () => document.getElementById('avatar-wrapper').classList.remove('speaking');
            
            synth.speak(utterThis);
        }

        document.getElementById('sound-btn').addEventListener('click', function() {
            isMuted = !isMuted;
            this.style.opacity = isMuted ? '0.5' : '1';
            if (isMuted) synth.cancel();
        });

        // --- INITIALIZATION ---
        document.getElementById('start-session-btn').addEventListener('click', () => {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                GEMINI_API_KEY = key;
                document.getElementById('api-modal').style.display = 'none';
                initTracker();
                // Send silent start prompt
                sendMessage(); 
            }
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('theme-btn').addEventListener('click', () => {
            document.body.classList.toggle('theme-ocean');
            // Re-init canvas colors
            initWaves();
        });

        // --- CANVAS BACKGROUND ---
        const canvas = document.getElementById('wave-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let waves = [];

        function initWaves() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            
            const style = getComputedStyle(document.body);
            const p = style.getPropertyValue('--primary-color').trim();
            
            // Helper to get RGB from hex
            const hex2rgba = (hex, alpha = 1) => {
                const [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16));
                return `rgba(${r},${g},${b},${alpha})`;
            };

            const color = p.startsWith('#') ? hex2rgba(p, 0.1) : 'rgba(100,100,100,0.1)';

            waves = [
                { y: height * 0.6, length: 0.002, amp: 60, speed: 0.002, offset: 0 },
                { y: height * 0.65, length: 0.003, amp: 40, speed: 0.003, offset: 2 },
                { y: height * 0.7, length: 0.001, amp: 80, speed: 0.001, offset: 4 }
            ];
            
            // Draw
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            
            const style = getComputedStyle(document.body);
            const p = style.getPropertyValue('--primary-color').trim();
            ctx.fillStyle = p.startsWith('#') ? p + '1A' : 'rgba(100,100,100,0.1)'; // Simple hex transparency hack

            waves.forEach(w => {
                ctx.beginPath();
                ctx.moveTo(0, height);
                ctx.lineTo(0, w.y);
                for (let x = 0; x <= width; x += 10) {
                    ctx.lineTo(x, w.y + Math.sin(x * w.length + w.offset) * w.amp);
                }
                ctx.lineTo(width, height);
                ctx.fill();
                w.offset += w.speed;
            });
            requestAnimationFrame(draw);
        }

        window.addEventListener('resize', initWaves);
        initWaves();

    </script>
</body>
</html>
```
