<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nour - AI Tutor</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Questrial&family=Marcellus&display=swap" rel="stylesheet">
    
    <!-- Markdown Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* =====================================================================
           DESIGN SYSTEM
           ===================================================================== */
        :root {
            /* Palette - Sage Theme (Default) */
            --primary-color: #5c6b53;
            --secondary-color: #8da386;
            --accent-color: #d4a373;
            --bg-color: #f0f2ef;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.9);
            --text-dark: #2a3328;
            
            /* Text Highlights (The Key) */
            --hl-vocab-bg: #eaddcf;     /* Warm Sand for Vocab */
            --hl-vocab-text: #8f5b34;   
            --hl-grammar-bg: #dee8e6;   /* Cool Mist for Grammar */
            --hl-grammar-text: #4a7c76; 
            --hl-alert-bg: #fce8e8;     /* Soft Rose for Correction */
            --hl-alert-text: #c45a5a;   

            /* Fonts */
            --font-display: "Marcellus", serif; 
            --font-body: "Nunito", sans-serif;
            --font-ui: "Questrial", sans-serif;
        }

        /* Ocean Theme */
        body.theme-ocean { 
            --primary-color: #46696d; --secondary-color: #72a5a5; 
            --hl-vocab-text: #d67a5b; --hl-grammar-text: #2c5559;
            --bg-color: #ebf2f2;
        }
        
        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0; height: 100dvh; font-family: var(--font-body);
            color: var(--text-dark); font-size: 16px;
            overflow: hidden; background: var(--bg-color); transition: background 0.8s ease;
        }

        /* Animation Canvas */
        #wave-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.5; }

        #app-wrapper {
            position: relative; z-index: 1; display: flex; align-items: center; justify-content: center;
            height: 100%; padding: 2vh;
        }

        #activity-container {
            width: 100%; max-width: 1400px; height: 96vh;
            display: grid; grid-template-columns: 1fr 340px; grid-template-rows: auto 1fr auto;
            background: var(--glass-bg); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 32px; border: 1px solid var(--glass-border);
            box-shadow: 0 30px 90px -20px rgba(42, 51, 40, 0.15); overflow: hidden;
        }

        /* --- HEADER --- */
        .chat-header {
            grid-column: 1 / -1; padding: 1.2rem 2.5rem;
            background: rgba(255,255,255,0.4); border-bottom: 1px solid rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        
        .header-left { display: flex; align-items: center; gap: 1.2rem; }
        .header-info h1 { font-family: var(--font-display); margin: 0; font-size: 1.4rem; color: var(--primary-color); }
        .header-status { font-family: var(--font-ui); font-size: 0.8rem; color: var(--secondary-color); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        .avatar-wrapper {
            position: relative; width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
        }
        .avatar-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background: linear-gradient(135deg, #8da386 0%, #5c6b53 50%, #d4a373 100%);
            color: #fff;
            font-family: var(--font-display); font-size: 1.8rem;
            font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
            box-shadow: 0 8px 24px rgba(92, 107, 83, 0.3),
                        inset 0 2px 6px rgba(255,255,255,0.3),
                        inset 0 -2px 6px rgba(0,0,0,0.1);
            animation: avatarFloat 3s ease-in-out infinite;
        }
        .avatar-circle::before {
            content: '';
            position: absolute;
            inset: 3px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 60%);
            pointer-events: none;
        }
        .avatar-aura {
            position: absolute; inset: -6px; border-radius: 50%;
            background: radial-gradient(circle, var(--accent-color) 0%, var(--secondary-color) 100%);
            opacity: 0.4; z-index: 1;
            animation: breathe 4s ease-in-out infinite;
            filter: blur(8px);
        }

        /* Avatar Animations */
        .avatar-wrapper.listening .avatar-aura {
            animation: pulseFast 0.8s infinite;
            background: radial-gradient(circle, #d4a373 0%, #8da386 100%);
            opacity: 0.7;
            filter: blur(12px);
        }
        .avatar-wrapper.speaking .avatar-circle {
            animation: speakPulse 0.4s infinite alternate, avatarFloat 3s ease-in-out infinite;
        }

        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-3px) scale(1.02); }
        }

        /* --- CHAT AREA --- */
        #chat-history {
            grid-column: 1 / 2; grid-row: 2 / 3;
            overflow-y: auto; padding: 3rem;
            display: flex; flex-direction: column; gap: 2rem; scroll-behavior: smooth;
        }

        .message {
            max-width: 85%; opacity: 0; 
            animation: floatIn 0.5s forwards; line-height: 1.7;
        }

        .message.ai {
            align-self: flex-start; width: 100%; max-width: 90%;
            font-size: 1.05rem; color: var(--text-dark);
        }
        
        .message.user {
            align-self: flex-end; padding: 1rem 1.5rem;
            color: white; border-radius: 20px 20px 4px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 8px 20px -5px rgba(92, 107, 83, 0.3);
        }

        .message.error {
            align-self: center; background: #ffebee; color: #c62828;
            padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem;
        }

        /* --- AI VISUAL COMPONENTS (CARDS & CAROUSELS) --- */
        
        /* Carousel Container */
        .carousel {
            display: flex; gap: 1.5rem; overflow-x: auto; 
            padding: 1.5rem 0.5rem; margin: 1rem 0;
            scroll-snap-type: x mandatory;
        }
        .carousel::-webkit-scrollbar { height: 6px; }
        .carousel::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

        /* Learning Card */
        .learning-card {
            flex: 0 0 260px; scroll-snap-align: center;
            background: #fff; border-radius: 20px;
            padding: 1.5rem; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.8);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .learning-card:hover { transform: translateY(-5px); }
        .learning-card h3 { 
            font-family: var(--font-display); color: var(--primary-color); 
            margin-top: 0; border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;
        }

        /* Dialogue Box - Organic Speech Bubble */
        .dialogue-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,247,0.8) 100%);
            border-radius: 24px 24px 24px 4px;
            padding: 1.8rem 2.2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 32px rgba(92, 107, 83, 0.12),
                        inset 0 1px 0 rgba(255,255,255,0.9);
            position: relative;
            border: 1px solid rgba(92, 107, 83, 0.08);
        }
        .dialogue-box::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid rgba(255,255,255,0.9);
        }
        .dialogue-speaker {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .dialogue-speaker::before {
            content: 'üí¨';
            font-size: 1.2rem;
        }
        .dialogue-content {
            line-height: 1.8;
            color: var(--text-dark);
        }
        .dialogue-content p {
            margin: 0.8rem 0;
        }
        .dialogue-content p:first-child {
            margin-top: 0;
        }
        .dialogue-content p:last-child {
            margin-bottom: 0;
        }
        /* Legacy support for old format */
        .d-line { margin-bottom: 1rem; display: flex; gap: 1rem; }
        .d-name { font-weight: 800; min-width: 80px; color: var(--primary-color); font-family: var(--font-display); }

        /* Highlights */
        .hl-vocab { background: var(--hl-vocab-bg); color: var(--hl-vocab-text); padding: 2px 6px; border-radius: 4px; font-weight: 700; border-bottom: 2px solid rgba(0,0,0,0.1); }
        .hl-grammar { background: var(--hl-grammar-bg); color: var(--hl-grammar-text); padding: 2px 6px; border-radius: 4px; font-weight: 700; border: 1px dashed var(--secondary-color); }
        .hl-feedback { background: var(--hl-alert-bg); color: var(--hl-alert-text); padding: 2px 6px; border-radius: 4px; text-decoration: underline wavy; }

        /* Metacognitive Widgets */
        .think-prompt {
            background: linear-gradient(135deg, #f8f4ff 0%, #ede7f6 100%);
            border-left: 4px solid #9575cd;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            font-style: italic;
            color: #4a148c;
            box-shadow: 0 4px 12px rgba(149, 117, 205, 0.1);
        }
        .think-prompt strong {
            font-style: normal;
            display: block;
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
        }

        .notice-box {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid #ffa726;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            color: #e65100;
            position: relative;
            box-shadow: 0 4px 12px rgba(255, 167, 38, 0.15);
        }
        .notice-box strong {
            display: block;
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
            font-size: 1.1rem;
        }

        .success-badge {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #66bb6a;
            border-radius: 20px;
            padding: 0.75rem 1.5rem;
            margin: 1rem 0;
            color: #2e7d32;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.2);
            animation: successPop 0.5s ease-out;
        }

        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Self-Assessment Widget */
        .self-check {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 2px solid var(--secondary-color);
        }
        .self-check h4 {
            font-family: var(--font-display);
            color: var(--primary-color);
            margin-top: 0;
        }
        .confidence-scale {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: space-between;
        }
        .confidence-option {
            flex: 1;
            padding: 0.75rem;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .confidence-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Sentence Stems Helper */
        .sentence-stems {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }
        .sentence-stems h4 {
            font-family: var(--font-display);
            color: #0d47a1;
            margin-top: 0;
            font-size: 1rem;
        }
        .stem-option {
            background: white;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            color: #1565c0;
            font-style: italic;
            border-left: 3px solid #42a5f5;
        }

        /* Progress Indicator Enhancement */
        .mini-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            margin: 1rem 0;
            font-size: 0.85rem;
        }
        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.5s ease;
        }

        /* --- SIDEBAR (NAVIGATOR) --- */
        #side-panel {
            grid-column: 2 / 3; grid-row: 2 / 4;
            background: rgba(255,255,255,0.5); border-left: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .panel-header {
            padding: 1.5rem; font-family: var(--font-display); font-weight: 700; 
            color: var(--primary-color); background: rgba(255,255,255,0.3);
        }

        #tracker-container {
            flex: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem 1.5rem;
        }
        
        .step-item {
            position: relative; padding: 0 0 1.5rem 1.5rem;
            border-left: 2px solid #e0e0e0;
        }
        .step-item:last-child { border-left: 2px solid transparent; }
        .step-dot {
            position: absolute; left: -7px; top: 0; width: 12px; height: 12px; 
            border-radius: 50%; background: #e0e0e0; border: 2px solid #fff; transition: all 0.3s;
        }
        .step-title { font-size: 0.8rem; color: #999; font-weight: 700; }

        .step-item.active .step-dot { background: var(--accent-color); transform: scale(1.3); }
        .step-item.active .step-title { color: var(--accent-color); }
        .step-item.done .step-dot { background: var(--primary-color); }
        .step-item.done { border-left-color: var(--primary-color); }

        /* Analytics Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label {
            font-size: 0.75rem;
            color: #666;
        }
        .stat-value {
            font-weight: 800;
            font-size: 0.9rem;
            color: var(--primary-color);
            font-family: var(--font-ui);
        }

        /* --- INPUT --- */
        .input-area {
            grid-column: 1 / 2; grid-row: 3 / 4;
            padding: 2rem 3rem; display: flex; gap: 1rem; align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1; background: #fff; border-radius: 28px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex; align-items: center; padding: 6px 6px 6px 20px;
        }
        
        textarea {
            width: 100%; border: none; background: transparent;
            font-family: var(--font-body); font-size: 1rem; outline: none; resize: none; max-height: 120px;
        }

        button.icon-btn {
            width: 44px; height: 44px; border-radius: 50%; border: none; background: transparent; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
            color: #aaa;
        }
        button.icon-btn:hover { background: #f5f5f5; color: var(--primary-color); }
        
        #mic-btn.listening { background: var(--hl-alert-text); color: white; animation: pulseRed 1.5s infinite; }
        #send-btn { width: 48px; height: 48px; background: var(--primary-color); color: white; border-radius: 20px; opacity: 0.9; }
        #send-btn:hover { opacity: 1; transform: scale(1.05); }

        /* Animations */
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.15; } }
        @keyframes floatIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        @keyframes pulseFast { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.2); opacity: 0.0; } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(196, 90, 90, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(196, 90, 90, 0); } 100% { box-shadow: 0 0 0 0 rgba(196, 90, 90, 0); } }
        @keyframes speakPulse { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* API Modal */
        #api-modal { position: fixed; inset: 0; background: rgba(240, 242, 239, 0.95); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 3rem; border-radius: 32px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.1); }
        .api-input { width: 100%; padding: 14px; margin: 1.5rem 0; border: 2px solid #eee; border-radius: 12px; outline: none; }
        .start-btn { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 99px; font-weight: 700; cursor: pointer; }

    </style>
</head>
<body class="theme-sage">

    <canvas id="wave-canvas"></canvas>

    <div id="app-wrapper">
        <div id="activity-container">
            
            <!-- HEADER -->
            <div class="chat-header">
                <div class="header-left">
                    <div class="avatar-wrapper" id="avatar-wrapper">
                        <div class="avatar-aura"></div>
                        <div class="avatar-circle">N</div>
                    </div>
                    <div class="header-info">
                        <h1>Nour</h1>
                        <div class="header-status" id="header-status">Waiting</div>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="icon-btn" id="sound-btn" title="Toggle Sound">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    </button>
                    <button class="icon-btn" id="theme-btn" title="Switch Theme">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </button>
                </div>
            </div>

            <!-- CHAT -->
            <div id="chat-history"></div>

            <!-- SIDEBAR -->
            <div id="side-panel">
                <div class="panel-header">Session Map</div>
                <div id="tracker-container"></div>

                <!-- Learning Analytics -->
                <div style="padding: 1.5rem; border-top: 1px solid rgba(0,0,0,0.05);">
                    <div style="font-family: var(--font-display); font-size: 0.85rem; color: var(--primary-color); margin-bottom: 1rem; font-weight: 700;">Session Insights</div>
                    <div id="analytics-display">
                        <div class="stat-row">
                            <span class="stat-label">üí¨ Your turns:</span>
                            <span class="stat-value" id="stat-turns">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">üìö New vocab:</span>
                            <span class="stat-value" id="stat-vocab">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">üéØ Grammar focus:</span>
                            <span class="stat-value" id="stat-grammar">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">‚ú® Successes:</span>
                            <span class="stat-value" id="stat-success">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top:auto; padding:1.5rem; text-align:center;">
                    <button class="start-btn" id="download-btn" style="font-size:0.9rem; padding:12px;">üìÑ Download Session Report</button>
                </div>
            </div>

            <!-- INPUT -->
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="user-input" placeholder="Type or tap microphone..." rows="1"></textarea>
                    <button class="icon-btn" id="mic-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                </div>
                <button class="icon-btn" id="send-btn" style="color:white;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="api-modal">
        <div class="modal-box">
            <h1 style="font-family:var(--font-display); color:var(--primary-color);">Welcome Back</h1>
            <p>Please enter your Gemini API Key to begin.</p>
            <input type="password" id="api-key-input" class="api-input" placeholder="Paste API Key here...">
            <button class="start-btn" id="start-session-btn">Start Session</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const MODEL_NAME = 'gemini-2.5-flash';
        let GEMINI_API_KEY = '';
        
        // --- STAGES FOR TRACKER ---
        const STAGES = [
            "Lead-in",
            "Pre task A (Activate)",
            "Pre task B (Model)",
            "Pre task C (Lang Focus)",
            "Pre task D (Pron)",
            "Task Prep",
            "Main Task",
            "Reporting",
            "Feedback"
        ];

        // --- SYSTEM PROMPT (Pedagogically Enhanced) ---
        const SYSTEM_PROMPT = `
You are Nour, a somatic, aesthetic AI tutor grounded in cognitive science and second language acquisition research. You are calm, patient, visual, and deeply pedagogical.
Your goal is to guide the student through a TBL lesson using specific visual HTML layouts while applying advanced learning principles.

### CRITICAL: FIRST MESSAGE REQUIREMENT
Your very first message MUST begin with a privacy disclaimer using this exact format:
\`\`\`html
<div class="notice-box">
<strong>üîí Privacy First:</strong> Please do not share any personal information, sensitive data, or private details during our session. Keep our conversation focused on learning.
</div>
\`\`\`

After the privacy notice, warmly greet the student and begin the lesson naturally.

### VISUAL & FORMATTING RULES (STRICT)
1.  **NO MARKDOWN LISTS**: When presenting options, steps, or choices, you MUST use the \`<div class="carousel">\` layout.
2.  **HIGHLIGHTS**:
    -   Vocabulary: \`<span class="hl-vocab">term</span>\`
    -   Grammar: \`<span class="hl-grammar">structure</span>\`
    -   Correction/Feedback: \`<span class="hl-feedback">correction</span>\`
3.  **DIALOGUES**: When showing conversations or monologues, use this NEW format:
    \`\`\`html
    <div class="dialogue-box">
        <div class="dialogue-speaker">Nour</div>
        <div class="dialogue-content">
            <p>First paragraph of continuous speech...</p>
            <p>Second paragraph if needed...</p>
            <p>Third paragraph...</p>
        </div>
    </div>
    \`\`\`
    This shows the speaker's name ONCE at the top, followed by all their dialogue content. Perfect for monologues or continuous speech.
4.  **CARDS**: Concepts must be in \`<div class="learning-card"><h3>Title</h3><p>Content</p></div>\`.
5.  **THINK PROMPTS**: For reflection moments, use \`<div class="think-prompt"><strong>ü§î Pause & Reflect:</strong> [question]</div>\`
6.  **NOTICE BOXES**: For language awareness, use \`<div class="notice-box"><strong>üëÅÔ∏è Notice:</strong> [pattern]</div>\`
7.  **SUCCESS INDICATORS**: Use \`<div class="success-badge">‚ú® [achievement]</div>\` for positive reinforcement
8.  **SENTENCE STEMS**: When providing scaffolding, use:
    \`\`\`html
    <div class="sentence-stems">
        <h4>üí¨ Use these sentence starters:</h4>
        <div class="stem-option">In my opinion, ___ because ___</div>
        <div class="stem-option">I believe that ___, whereas ___</div>
    </div>
    \`\`\`
9.  **SELF-ASSESSMENT**: After teaching moments, prompt metacognition:
    \`\`\`html
    <div class="self-check">
        <h4>How confident do you feel?</h4>
        <p style="font-size:0.9rem; margin:0.5rem 0;">Think about what we just covered...</p>
    </div>
    \`\`\`

### PEDAGOGICAL FRAMEWORK (SACRED PRINCIPLES)

#### 1. ZONE OF PROXIMAL DEVELOPMENT (ZPD)
- Continuously assess student's current level through their responses
- Provide scaffolding that is "i+1" (just beyond current ability)
- If student struggles: simplify, model, provide sentence stems, break into smaller steps
- If student excels: extend with deeper questions, add complexity, encourage elaboration
- Use the carousel to offer differentiated difficulty options when appropriate

#### 2. SCAFFOLDING TECHNIQUES
- **Modeling**: Show examples before asking students to produce
- **Think-Alouds**: Verbalize your reasoning process in cards
- **Sentence Stems**: Provide frames like "In my opinion, ___ because ___"
- **Gradual Release**: I do ‚Üí We do ‚Üí You do with support ‚Üí You do independently
- **Multimodal Support**: Combine text, dialogue examples, and visual cards

#### 3. ERROR CORRECTION STRATEGIES (VARY YOUR APPROACH)
- **Recasts**: Subtly reformulate errors correctly without explicit correction
  Example: Student: "He go to work" ‚Üí You: "Ah yes, he goes to work every day, doesn't he?"
- **Clarification Requests**: "I'm not sure I understood, could you say that again?"
- **Metalinguistic Feedback**: Use \`<span class="hl-grammar">\` and explain the rule in a card
- **Elicitation**: Pause before the error and let student self-correct: "He ___?"
- **Explicit Correction**: Only for persistent errors. Use \`<span class="hl-feedback">\`
- CRITICAL: Don't correct everything. Prioritize errors that impede communication or match lesson focus.

#### 4. SOCRATIC QUESTIONING
Layer your questions to build critical thinking:
- **Clarifying**: "What do you mean by...?"
- **Probing Assumptions**: "What are we assuming here?"
- **Probing Reasons/Evidence**: "Why do you think that?"
- **Viewpoints**: "What might someone who disagrees say?"
- **Implications**: "If that's true, then what else must be true?"
- **Meta-questions**: "Why do you think I asked that question?"

#### 5. FORMATIVE ASSESSMENT (CONSTANT MONITORING)
- Ask check-in questions: "Does this make sense so far?"
- Use concept checks: "So if I say 'If I had time', am I talking about now or the past?"
- Observe response time, complexity, accuracy, fluency
- Adjust pacing based on student readiness signals
- Provide immediate, specific, actionable feedback

#### 6. RETRIEVAL PRACTICE
- Regularly circle back to previous vocabulary/concepts without warning
- Use the \`<div class="think-prompt">\` to ask: "Earlier we discussed X. What do you remember about...?"
- Space repetitions across the session (not blocked practice)
- Test before teaching to activate prior knowledge

#### 7. METACOGNITION & SELF-REGULATION
- Make thinking visible: "Let me show you how I would approach this..."
- Ask reflective questions: "What strategy did you just use?" "What was challenging about that?"
- Encourage self-assessment: Use carousel with options like "I'm confident / I need more practice / I'm unsure"
- End segments with: "What's one thing you learned? One thing you're still wondering?"

#### 8. ENGAGEMENT & AFFECT
- Use warm, encouraging language with specific praise: "I love how you used 'whereas' to show contrast!"
- Acknowledge difficulty: "This is a tricky structure - even native speakers mix it up"
- Connect to student's life/interests from their responses
- Maintain curiosity and enthusiasm in your tone
- Use the success badge sparingly for genuine achievements

#### 9. WAIT TIME
- After asking a complex question, explicitly say: "Take your time to think..."
- Don't rush to fill silence - students need processing time
- For deep questions, use the think-prompt widget to signal thinking is valued

#### 10. DUAL CODING
- Always pair abstract grammar with concrete examples in dialogues
- Use visual layout (cards, carousels) to complement verbal explanations
- When teaching vocabulary, embed it in meaningful context (dialogue) not just definitions

#### 11. INTERLEAVING & DISTRIBUTED PRACTICE
- Don't block all vocabulary together, then all grammar - mix them
- Return to earlier concepts while introducing new ones
- Connect new language to previously learned structures

#### 12. OUTPUT MAXIMIZATION
- Keep YOUR turns concise to maximize STUDENT talk time
- Use elicitation over explanation: "Can you give me an example?" rather than giving examples
- Encourage elaboration: "Tell me more about that" "What else?"
- Create genuine communication gaps that require language use

### TRACKER CONTROL
At the start of every message, you MUST output a hidden tag indicating the current stage from this list: [${STAGES.join(', ')}].
Format: \`[[STAGE: Pre task A (Activate)]]\`

### LESSON PLAN (ENHANCED)
1.  **Lead-in**: Ask a somatic grounding question. Connect body ‚Üí mind ‚Üí language.
2.  **Pre task A (Activate)**: Elicit prior knowledge about software projects using Socratic questions. Use carousel for memory retrieval options.
3.  **Pre task B (Model)**: Present a rich dialogue between Nadia and Omar about 'Dependencies'. After, use concept check questions.
4.  **Pre task C (Lang Focus)**: Analyze 'Second Conditional' with CARD layout. Include notice boxes for pattern recognition. Provide multiple examples.
5.  **Pre task D (Pron)**: Focus on weak forms, stress patterns. Use think prompts for noticing. Model then elicit.
6.  **Task Prep**: Assign roles (Monolith vs Microservices). Provide thinking time, sentence stems, vocabulary support via carousel.
7.  **Main Task**: Facilitate roleplay debate. Monitor and note errors WITHOUT interrupting. Encourage extended turns.
8.  **Reporting**: Have student reflect on their performance. Ask what went well, what was challenging.
9.  **Feedback**: Provide corrections using highlights. Focus on 2-3 priority areas. Use varied correction strategies. End with specific praise and one concrete goal.

### CONVERSATION PRINCIPLES
- Respond to what the student ACTUALLY says, not a script
- Follow natural conversation flow while gently guiding toward learning goals
- Be genuinely curious about their ideas
- Balance warmth with rigor
- Less is more - don't overwhelm with information
- Trust the process - deep learning takes time

Start the conversation now with authentic presence.
`;

        // --- UI LOGIC ---
        const chatEl = document.getElementById('chat-history');
        const inputEl = document.getElementById('user-input');
        const trackerContainer = document.getElementById('tracker-container');
        let chatHistory = [];
        let isMuted = false;

        // Learning Analytics Tracker
        let sessionMetrics = {
            userTurns: 0,
            vocabCount: 0,
            grammarCount: 0,
            successCount: 0
        };

        function updateAnalytics() {
            document.getElementById('stat-turns').textContent = sessionMetrics.userTurns;
            document.getElementById('stat-vocab').textContent = sessionMetrics.vocabCount;
            document.getElementById('stat-grammar').textContent = sessionMetrics.grammarCount;
            document.getElementById('stat-success').textContent = sessionMetrics.successCount;
        }

        // Initialize Tracker
        function initTracker() {
            trackerContainer.innerHTML = '';
            STAGES.forEach((stage, i) => {
                const el = document.createElement('div');
                el.className = `step-item ${i === 0 ? 'active' : ''}`;
                el.id = `stage-${i}`;
                el.innerHTML = `<div class="step-dot"></div><div class="step-title">${stage}</div>`;
                trackerContainer.appendChild(el);
            });
        }

        function updateTracker(stageName) {
            const idx = STAGES.findIndex(s => stageName.toLowerCase().includes(s.toLowerCase().split(' ')[0].toLowerCase()));
            if (idx !== -1) {
                for(let i=0; i<idx; i++) {
                    document.getElementById(`stage-${i}`).classList.remove('active');
                    document.getElementById(`stage-${i}`).classList.add('done');
                }
                const curr = document.getElementById(`stage-${idx}`);
                curr.classList.remove('done');
                curr.classList.add('active');
                curr.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        // --- MARKDOWN & PARSING ---
        // Ensure we handle [object Object] by properly extracting text
        async function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            // Clean tags for display
            let displayHtml = text.replace(/\[\[STAGE:.*?\]\]/g, '');
            
            // Render Markdown/HTML
            try {
                // If marked isn't loaded for some reason, fallback to text
                if (typeof marked !== 'undefined') {
                    div.innerHTML = marked.parse(displayHtml);
                } else {
                    div.innerHTML = displayHtml;
                }
            } catch (e) {
                console.error("Markdown Error", e);
                div.textContent = displayHtml;
            }

            chatEl.appendChild(div);
            // Wait for images/layout before scrolling
            requestAnimationFrame(() => {
                chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' });
            });
        }

        async function processAIResponse(rawText) {
            // Extract Stage
            const stageMatch = rawText.match(/\[\[STAGE:\s*(.*?)\]\]/);
            if (stageMatch) {
                updateTracker(stageMatch[1]);
            }

            // Track learning elements
            const vocabMatches = (rawText.match(/class="hl-vocab"/g) || []).length;
            const grammarMatches = (rawText.match(/class="hl-grammar"/g) || []).length;
            const successMatches = (rawText.match(/class="success-badge"/g) || []).length;

            sessionMetrics.vocabCount += vocabMatches;
            sessionMetrics.grammarCount += grammarMatches;
            sessionMetrics.successCount += successMatches;
            updateAnalytics();

            return rawText;
        }

        // --- API CALL ---
        async function sendMessage() {
            const text = inputEl.value.trim();
            if (!text) return;

            inputEl.value = '';
            appendMessage('user', text);

            // Track user turn
            sessionMetrics.userTurns++;
            updateAnalytics();

            document.getElementById('header-status').textContent = "Thinking...";
            document.getElementById('avatar-wrapper').classList.add('listening');

            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        system_instruction: { parts: [{ text: SYSTEM_PROMPT }] }
                    })
                });

                const data = await response.json();
                
                // CRITICAL FIX: Handle potential API errors or malformed data
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("Empty response from AI");
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Process and Display
                const processedText = await processAIResponse(aiText);
                appendMessage('ai', processedText);
                
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                
                // Speak
                if (!isMuted) speak(processedText);

            } catch (error) {
                console.error(error);
                appendMessage('error', `Error: ${error.message}`);
            } finally {
                document.getElementById('header-status').textContent = "Online";
                document.getElementById('avatar-wrapper').classList.remove('listening');
            }
        }

        // --- SPEECH RECOGNITION (FIXED) ---
        let recognition;
        const micBtn = document.getElementById('mic-btn');
        
        // Browser compatibility check
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                micBtn.classList.add('listening');
                inputEl.placeholder = "Listening...";
            };
            
            recognition.onend = () => {
                micBtn.classList.remove('listening');
                inputEl.placeholder = "Type or tap microphone...";
                // Trigger send automatically if desired, or let user click send
            };
            
            recognition.onerror = (event) => {
                console.error("Speech Error:", event.error);
                micBtn.classList.remove('listening');
                alert("Microphone error: " + event.error);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputEl.value = transcript;
            };

            micBtn.addEventListener('click', () => {
                if (micBtn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
        } else {
            micBtn.style.display = 'none'; // Hide if not supported
            console.log("Speech Recognition not supported in this browser.");
        }

        // --- TEXT TO SPEECH (Google Gemini TTS) ---
        let currentAudio = null;
        const TTS_MODEL = 'gemini-2.5-flash-preview-tts';

        async function speak(text) {
            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // Clean HTML tags and special markers for speech
            const cleanText = text.replace(/<[^>]*>/g, '').replace(/\[\[.*?\]\]/g, '').trim();

            if (!cleanText) return;

            document.getElementById('avatar-wrapper').classList.add('speaking');

            try {
                // Call Google Gemini TTS API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: cleanText }]
                        }],
                        generationConfig: {
                            responseModalities: ["audio"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: {
                                        voiceName: "Aoede" // Natural female voice
                                    }
                                }
                            }
                        }
                    })
                });

                const data = await response.json();

                if (data.error) {
                    console.error("TTS Error:", data.error);
                    // Fallback to browser TTS if API fails
                    fallbackSpeak(cleanText);
                    return;
                }

                // Extract audio data and play
                if (data.candidates && data.candidates[0].content.parts[0].inlineData) {
                    const audioData = data.candidates[0].content.parts[0].inlineData.data;
                    const audioBlob = base64ToBlob(audioData, 'audio/mp3');
                    const audioUrl = URL.createObjectURL(audioBlob);

                    currentAudio = new Audio(audioUrl);
                    currentAudio.onended = () => {
                        document.getElementById('avatar-wrapper').classList.remove('speaking');
                        URL.revokeObjectURL(audioUrl);
                        currentAudio = null;
                    };
                    currentAudio.onerror = () => {
                        document.getElementById('avatar-wrapper').classList.remove('speaking');
                        fallbackSpeak(cleanText);
                    };

                    await currentAudio.play();
                } else {
                    fallbackSpeak(cleanText);
                }
            } catch (error) {
                console.error("TTS Error:", error);
                fallbackSpeak(cleanText);
            }
        }

        // Fallback to browser speech synthesis
        function fallbackSpeak(text) {
            const synth = window.speechSynthesis;
            if (synth.speaking) synth.cancel();

            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.pitch = 1;
            utterThis.rate = 1.1;

            utterThis.onend = () => document.getElementById('avatar-wrapper').classList.remove('speaking');
            synth.speak(utterThis);
        }

        // Helper function to convert base64 to blob
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                byteArrays.push(new Uint8Array(byteNumbers));
            }

            return new Blob(byteArrays, { type: mimeType });
        }

        document.getElementById('sound-btn').addEventListener('click', function() {
            isMuted = !isMuted;
            this.style.opacity = isMuted ? '0.5' : '1';
            if (isMuted && currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (isMuted && window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        });

        // --- INITIALIZATION ---
        document.getElementById('start-session-btn').addEventListener('click', async () => {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                GEMINI_API_KEY = key;
                document.getElementById('api-modal').style.display = 'none';
                initTracker();

                // Auto-start conversation
                document.getElementById('header-status').textContent = "Initializing...";
                document.getElementById('avatar-wrapper').classList.add('listening');

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [],
                            system_instruction: { parts: [{ text: SYSTEM_PROMPT }] }
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    if (data.candidates && data.candidates[0].content) {
                        const aiText = data.candidates[0].content.parts[0].text;
                        const processedText = await processAIResponse(aiText);
                        appendMessage('ai', processedText);
                        chatHistory.push({ role: "model", parts: [{ text: aiText }] });

                        if (!isMuted) speak(processedText);
                    }
                } catch (error) {
                    console.error(error);
                    appendMessage('error', `Error: ${error.message}`);
                } finally {
                    document.getElementById('header-status').textContent = "Online";
                    document.getElementById('avatar-wrapper').classList.remove('listening');
                }
            }
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);

        // Enter key to send (Shift+Enter for new line)
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        inputEl.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        document.getElementById('theme-btn').addEventListener('click', () => {
            document.body.classList.toggle('theme-ocean');
            // Re-init canvas colors
            initWaves();
        });

        // --- CANVAS BACKGROUND ---
        const canvas = document.getElementById('wave-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let waves = [];

        function initWaves() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            
            const style = getComputedStyle(document.body);
            const p = style.getPropertyValue('--primary-color').trim();
            
            // Helper to get RGB from hex
            const hex2rgba = (hex, alpha = 1) => {
                const [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16));
                return `rgba(${r},${g},${b},${alpha})`;
            };

            const color = p.startsWith('#') ? hex2rgba(p, 0.1) : 'rgba(100,100,100,0.1)';

            waves = [
                { y: height * 0.6, length: 0.002, amp: 60, speed: 0.002, offset: 0 },
                { y: height * 0.65, length: 0.003, amp: 40, speed: 0.003, offset: 2 },
                { y: height * 0.7, length: 0.001, amp: 80, speed: 0.001, offset: 4 }
            ];
            
            // Draw
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            
            const style = getComputedStyle(document.body);
            const p = style.getPropertyValue('--primary-color').trim();
            ctx.fillStyle = p.startsWith('#') ? p + '1A' : 'rgba(100,100,100,0.1)'; // Simple hex transparency hack

            waves.forEach(w => {
                ctx.beginPath();
                ctx.moveTo(0, height);
                ctx.lineTo(0, w.y);
                for (let x = 0; x <= width; x += 10) {
                    ctx.lineTo(x, w.y + Math.sin(x * w.length + w.offset) * w.amp);
                }
                ctx.lineTo(width, height);
                ctx.fill();
                w.offset += w.speed;
            });
            requestAnimationFrame(draw);
        }

        window.addEventListener('resize', initWaves);
        initWaves();

        // --- PDF GENERATION ---
        document.getElementById('download-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Title
            doc.setFontSize(22);
            doc.setTextColor(92, 107, 83);
            doc.text('Nour Learning Session Report', 20, 20);

            // Date
            doc.setFontSize(10);
            doc.setTextColor(100);
            const today = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            doc.text(today, 20, 28);

            // Session Analytics
            doc.setFontSize(14);
            doc.setTextColor(92, 107, 83);
            doc.text('Session Analytics', 20, 40);

            doc.setFontSize(11);
            doc.setTextColor(50);
            let y = 50;
            doc.text(`üí¨ Your conversation turns: ${sessionMetrics.userTurns}`, 25, y);
            y += 8;
            doc.text(`üìö New vocabulary items: ${sessionMetrics.vocabCount}`, 25, y);
            y += 8;
            doc.text(`üéØ Grammar structures practiced: ${sessionMetrics.grammarCount}`, 25, y);
            y += 8;
            doc.text(`‚ú® Success moments: ${sessionMetrics.successCount}`, 25, y);
            y += 15;

            // Conversation Transcript
            doc.setFontSize(14);
            doc.setTextColor(92, 107, 83);
            doc.text('Conversation Highlights', 20, y);
            y += 10;

            doc.setFontSize(10);
            doc.setTextColor(50);

            // Extract clean text from chat
            chatHistory.forEach((msg, i) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                const role = msg.role === 'user' ? 'You' : 'Nour';
                const text = msg.parts[0].text.replace(/<[^>]*>/g, '').replace(/\[\[STAGE:.*?\]\]/g, '').substring(0, 200);

                doc.setFont(undefined, 'bold');
                doc.text(`${role}:`, 20, y);
                doc.setFont(undefined, 'normal');

                const lines = doc.splitTextToSize(text, 170);
                doc.text(lines.slice(0, 3), 20, y + 5);
                y += 5 + (Math.min(lines.length, 3) * 5) + 5;
            });

            // Footer
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            y = 280;
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generated by Nour AI Tutor | Keep practicing, keep growing! üå±', 20, y);

            doc.save(`nour-session-${Date.now()}.pdf`);
        });

    </script>
</body>
</html>
```
